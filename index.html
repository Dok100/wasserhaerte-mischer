<!doctype html>
<html lang="de">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Wasserhärte-Mischer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 18 UMD + Babel for JSX -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // ---------- Helpers ----------
        function parseNum(input) {
            if (input == null) return NaN;
            const s = String(input).trim().replace(/\./g, "").replace(",", "."); // 1.234,56 -> 1234.56
            if (s === "") return NaN;
            return Number(s);
        }
        function formatNum(n, digits = 2) {
            if (!isFinite(n)) return "–";
            return new Intl.NumberFormat("de-DE", { maximumFractionDigits: digits, minimumFractionDigits: digits }).format(n);
        }
        function useLocal(key, initial) {
            const [val, setVal] = useState(() => {
                try {
                    const raw = localStorage.getItem(key);
                    return raw ? JSON.parse(raw) : initial;
                } catch { return initial; }
            });
            useEffect(() => {
                try { localStorage.setItem(key, JSON.stringify(val)); } catch { }
            }, [key, val]);
            return [val, setVal];
        }

        // ---------- App ----------
        function App() {
            // Persisted inputs (Mischrechner)
            const [lwHard, setLwHard] = useLocal("lwHardness", "16,6"); // °dH
            const [mwHard, setMwHard] = useLocal("mwHardness", "0,8");  // °dH
            const [targetHard, setTargetHard] = useLocal("targetHardness", "7,0");
            const [mode, setMode] = useLocal("mixMode", "total"); // "total" | "fixedLW"
            const [totalVol, setTotalVol] = useLocal("totalVolume", "2,50"); // L
            const [lwVol, setLwVol] = useLocal("lwVolume", "1,00"); // L
            const [priceLW, setPriceLW] = useLocal("priceLW", "0,00"); // €/L
            const [priceMW, setPriceMW] = useLocal("priceMW", "0,50"); // €/L

            // Hardness calculator inputs (persisted) – getrennt für LW & MW
            const [caLW, setCaLW] = useLocal("calcCaLW", "99,1");
            const [mgLW, setMgLW] = useLocal("calcMgLW", "22,4");
            const [caMW, setCaMW] = useLocal("calcCaMW", "4,2");
            const [mgMW, setMgMW] = useLocal("calcMgMW", "1,2");

            // Derived numbers (mixing)
            const lw = parseNum(lwHard);
            const mw = parseNum(mwHard);
            const tgt = parseNum(targetHard);
            const Vtot = parseNum(totalVol);
            const Vlw = parseNum(lwVol);
            const pLW = parseNum(priceLW);
            const pMW = parseNum(priceMW);

            // Härte aus Ca & Mg (°dH ≈ Ca/7,14 + Mg/4,34)
            const dHLW = useMemo(() => {
                const ca = parseNum(caLW), mg = parseNum(mgLW);
                if (!isFinite(ca) || !isFinite(mg)) return NaN;
                return ca / 7.14 + mg / 4.34;
            }, [caLW, mgLW]);

            const dHMW = useMemo(() => {
                const ca = parseNum(caMW), mg = parseNum(mgMW);
                if (!isFinite(ca) || !isFinite(mg)) return NaN;
                return ca / 7.14 + mg / 4.34;
            }, [caMW, mgMW]);

            // Mischung rechnen
            const calc = useMemo(() => {
                const warn = [];
                if (!isFinite(lw) || !isFinite(mw) || !isFinite(tgt)) {
                    warn.push("Bitte gültige Härten (°dH) eingeben.");
                    return { vLW: NaN, vMW: NaN, total: NaN, cost: NaN, warn };
                }
                if (lw === mw) warn.push("LW- und MW-Härte sind identisch – Mischung ändert die Härte nicht.");
                const between = tgt >= Math.min(lw, mw) && tgt <= Math.max(lw, mw);
                if (!between) warn.push("Zielhärte liegt außerhalb der Spanne von LW/MW – Ergebnis ist eine Extrapolation.");

                if (mode === "total") {
                    if (!isFinite(Vtot) || Vtot <= 0) {
                        warn.push("Bitte eine gültige Gesamtmenge (L) eingeben.");
                        return { vLW: NaN, vMW: NaN, total: NaN, cost: NaN, warn };
                    }
                    const denom = lw - mw; if (denom === 0) return { vLW: NaN, vMW: NaN, total: NaN, cost: NaN, warn };
                    const fracLW = (tgt - mw) / denom;
                    const vLW = fracLW * Vtot;
                    const vMW = (1 - fracLW) * Vtot;
                    const cost = vLW * pLW + vMW * pMW;
                    return { vLW, vMW, total: Vtot, cost, warn };
                } else {
                    if (!isFinite(Vlw) || Vlw <= 0) {
                        warn.push("Bitte eine gültige Menge Leitungswasser (L) eingeben.");
                        return { vLW: NaN, vMW: NaN, total: NaN, cost: NaN, warn };
                    }
                    const denom = tgt - mw; if (denom === 0) return { vLW: Vlw, vMW: NaN, total: NaN, cost: NaN, warn };
                    const vMW = Vlw * (lw - tgt) / denom; // y = x*(LW−Ziel)/(Ziel−MW)
                    const total = Vlw + vMW;
                    const cost = Vlw * pLW + vMW * pMW;
                    return { vLW: Vlw, vMW, total, cost, warn };
                }
            }, [lw, mw, tgt, Vtot, Vlw, pLW, pMW, mode]);

            function resetAll() {
                setLwHard("16,6"); setMwHard("0,8"); setTargetHard("7,0");
                setMode("total"); setTotalVol("2,50"); setLwVol("1,00");
                setPriceLW("0,00"); setPriceMW("0,50");
                setCaLW("99,1"); setMgLW("22,4"); setCaMW("4,2"); setMgMW("1,2");
                try { localStorage.clear(); } catch { }
            }

            return (
                <div className="min-h-screen bg-gray-50 text-gray-900 p-6">
                    <div className="max-w-5xl mx-auto space-y-6">
                        <header className="flex items-center justify-between">
                            <h1 className="text-2xl font-bold">Wasserhärte-Mischer</h1>
                            <button onClick={resetAll} className="px-3 py-2 rounded-xl bg-gray-200 hover:bg-gray-300 text-sm">Zurücksetzen</button>
                        </header>

                        {/* Härte-Rechner – Leitungswasser */}
                        <div className="bg-white p-4 rounded-2xl shadow-sm">
                            <h2 className="font-semibold mb-3">Härte-Rechner – Leitungswasser</h2>
                            <div className="grid md:grid-cols-4 gap-4 items-end">
                                <div>
                                    <label className="block text-sm mb-1">Calcium (mg/L)</label>
                                    <input value={caLW} onChange={e => setCaLW(e.target.value)} className="w-full p-2 rounded-xl border" />
                                </div>
                                <div>
                                    <label className="block text-sm mb-1">Magnesium (mg/L)</label>
                                    <input value={mgLW} onChange={e => setMgLW(e.target.value)} className="w-full p-2 rounded-xl border" />
                                </div>
                                <div className="p-3 rounded-xl bg-gray-100">
                                    <div className="text-sm text-gray-600">Härte Leitungswasser</div>
                                    <div className="text-2xl font-semibold">{formatNum(dHLW, 2)} °dH</div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setLwHard(formatNum(dHLW, 2))} className="px-3 py-2 rounded-xl border bg-gray-900 text-white w-full">
                                        In Mischrechner übernehmen
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Härte-Rechner – Mineralwasser */}
                        <div className="bg-white p-4 rounded-2xl shadow-sm">
                            <h2 className="font-semibold mb-3">Härte-Rechner – Mineralwasser</h2>
                            <div className="grid md:grid-cols-4 gap-4 items-end">
                                <div>
                                    <label className="block text-sm mb-1">Calcium (mg/L)</label>
                                    <input value={caMW} onChange={e => setCaMW(e.target.value)} className="w-full p-2 rounded-xl border" />
                                </div>
                                <div>
                                    <label className="block text-sm mb-1">Magnesium (mg/L)</label>
                                    <input value={mgMW} onChange={e => setMgMW(e.target.value)} className="w-full p-2 rounded-xl border" />
                                </div>
                                <div className="p-3 rounded-xl bg-gray-100">
                                    <div className="text-sm text-gray-600">Härte Mineralwasser</div>
                                    <div className="text-2xl font-semibold">{formatNum(dHMW, 2)} °dH</div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setMwHard(formatNum(dHMW, 2))} className="px-3 py-2 rounded-xl border bg-gray-900 text-white w-full">
                                        In Mischrechner übernehmen
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Mischrechner – Eingaben & Preise */}
                        <div className="grid md:grid-cols-3 gap-4">
                            {/* Härten für den Mischrechner */}
                            <div className="bg-white p-4 rounded-2xl shadow-sm">
                                <h2 className="font-semibold mb-3">Mischrechner – Härte (°dH)</h2>
                                <label className="block text-sm mb-1">Leitungswasser</label>
                                <input value={lwHard} onChange={e => setLwHard(e.target.value)} className="w-full p-2 rounded-xl border mb-3" placeholder="z. B. 16,6" />
                                <label className="block text-sm mb-1">Mineralwasser</label>
                                <input value={mwHard} onChange={e => setMwHard(e.target.value)} className="w-full p-2 rounded-xl border" placeholder="z. B. 0,8" />
                                <div className="text-xs text-gray-500 mt-2">Tipp: Oben berechnen und hier übernehmen.</div>
                            </div>

                            {/* Mischmodus & Ziel */}
                            <div className="bg-white p-4 rounded-2xl shadow-sm">
                                <h2 className="font-semibold mb-3">Mischmodus & Ziel</h2>
                                <div className="flex gap-2 mb-4">
                                    <button onClick={() => setMode("total")} className={`px-3 py-2 rounded-xl border ${mode === 'total' ? 'bg-gray-900 text-white' : 'bg-white'}`}>Gesamtmenge</button>
                                    <button onClick={() => setMode("fixedLW")} className={`px-3 py-2 rounded-xl border ${mode === 'fixedLW' ? 'bg-gray-900 text-white' : 'bg-white'}`}>x L Leitungswasser</button>
                                </div>
                                {mode === 'total' ? (
                                    <>
                                        <label className="block text-sm mb-1">Gesamtmenge (L)</label>
                                        <input value={totalVol} onChange={e => setTotalVol(e.target.value)} className="w-full p-2 rounded-xl border" placeholder="z. B. 2,50" />
                                    </>
                                ) : (
                                    <>
                                        <label className="block text-sm mb-1">Leitungswasser (L)</label>
                                        <input value={lwVol} onChange={e => setLwVol(e.target.value)} className="w-full p-2 rounded-xl border" placeholder="z. B. 1,00" />
                                    </>
                                )}
                                <label className="block text-sm mt-3 mb-1">Zielhärte (°dH)</label>
                                <input value={targetHard} onChange={e => setTargetHard(e.target.value)} className="w-full p-2 rounded-xl border" placeholder="z. B. 7,0" />
                            </div>

                            {/* Preise */}
                            <div className="bg-white p-4 rounded-2xl shadow-sm">
                                <h2 className="font-semibold mb-3">Preise (optional)</h2>
                                <label className="block text-sm mb-1">Preis Leitungswasser (€/L)</label>
                                <input value={priceLW} onChange={e => setPriceLW(e.target.value)} className="w-full mb-3 p-2 rounded-xl border" placeholder="0,00" />
                                <label className="block text-sm mb-1">Preis Mineralwasser (€/L)</label>
                                <input value={priceMW} onChange={e => setPriceMW(e.target.value)} className="w-full p-2 rounded-xl border" placeholder="0,50" />
                            </div>
                        </div>

                        {/* Ergebnis */}
                        <div className="bg-white p-4 rounded-2xl shadow-sm">
                            <h2 className="font-semibold mb-3">Ergebnis</h2>
                            <div className="grid md:grid-cols-4 gap-4">
                                <div className="p-3 rounded-xl bg-gray-100">
                                    <div className="text-sm text-gray-600">Leitungswasser</div>
                                    <div className="text-2xl font-semibold">{formatNum(calc.vLW)} L</div>
                                </div>
                                <div className="p-3 rounded-xl bg-gray-100">
                                    <div className="text-sm text-gray-600">Mineralwasser</div>
                                    <div className="text-2xl font-semibold">{formatNum(calc.vMW)} L</div>
                                </div>
                                <div className="p-3 rounded-xl bg-gray-100">
                                    <div className="text-sm text-gray-600">Gesamt</div>
                                    <div className="text-2xl font-semibold">{formatNum(calc.total)} L</div>
                                </div>
                                <div className="p-3 rounded-xl bg-gray-100">
                                    <div className="text-sm text-gray-600">Kosten</div>
                                    <div className="text-2xl font-semibold">
                                        {isFinite(calc.cost) ? `${formatNum(calc.cost)} € (${formatNum(calc.cost / calc.total)} €/L)` : "–"}
                                    </div>
                                </div>
                            </div>
                            {calc.warn.length > 0 && (
                                <ul className="mt-4 text-sm text-yellow-800 bg-yellow-50 border border-yellow-200 rounded-xl p-3 list-disc list-inside">
                                    {calc.warn.map((w, i) => (<li key={i}>{w}</li>))}
                                </ul>
                            )}
                            <div className="text-xs text-gray-500 mt-2">
                                Formel (Gesamtmenge): Anteil LW = (Ziel − MW) / (LW − MW); Anteil MW = 1 − Anteil LW. <br />
                                Formel (x L LW): MW = LW_Menge · (LW − Ziel) / (Ziel − MW).
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>

</html>